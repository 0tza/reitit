
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Composing Routers Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hints/plugin-hints.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="different_routers.html" />
    
    
    <link rel="prev" href="configuring_routers.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Introduction</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Basics</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../basics/route_syntax.html">
            
                <a href="../basics/route_syntax.html">
            
                    
                    Route Syntax
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../basics/router.html">
            
                <a href="../basics/router.html">
            
                    
                    Router
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../basics/path_based_routing.html">
            
                <a href="../basics/path_based_routing.html">
            
                    
                    Path-based Routing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../basics/name_based_routing.html">
            
                <a href="../basics/name_based_routing.html">
            
                    
                    Name-based Routing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../basics/route_data.html">
            
                <a href="../basics/route_data.html">
            
                    
                    Route Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="../basics/route_data_validation.html">
            
                <a href="../basics/route_data_validation.html">
            
                    
                    Route Data Validation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="../basics/route_conflicts.html">
            
                <a href="../basics/route_conflicts.html">
            
                    
                    Route Conflicts
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Coercion</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../coercion/coercion.html">
            
                <a href="../coercion/coercion.html">
            
                    
                    Coercion Explained
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../coercion/schema_coercion.html">
            
                <a href="../coercion/schema_coercion.html">
            
                    
                    Plumatic Schema
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../coercion/clojure_spec_coercion.html">
            
                <a href="../coercion/clojure_spec_coercion.html">
            
                    
                    Clojure.spec
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="../coercion/data_spec_coercion.html">
            
                <a href="../coercion/data_spec_coercion.html">
            
                    
                    Data-specs
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Ring</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../ring/ring.html">
            
                <a href="../ring/ring.html">
            
                    
                    Ring-router
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../ring/reverse_routing.html">
            
                <a href="../ring/reverse_routing.html">
            
                    
                    Reverse-routing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../ring/default_handler.html">
            
                <a href="../ring/default_handler.html">
            
                    
                    Default handler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="../ring/slash_handler.html">
            
                <a href="../ring/slash_handler.html">
            
                    
                    Slash handler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="../ring/static.html">
            
                <a href="../ring/static.html">
            
                    
                    Static Resources
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="../ring/dynamic_extensions.html">
            
                <a href="../ring/dynamic_extensions.html">
            
                    
                    Dynamic Extensions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7" data-path="../ring/data_driven_middleware.html">
            
                <a href="../ring/data_driven_middleware.html">
            
                    
                    Data-driven Middleware
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.8" data-path="../ring/transforming_middleware_chain.html">
            
                <a href="../ring/transforming_middleware_chain.html">
            
                    
                    Transforming Middleware Chain
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.9" data-path="../ring/middleware_registry.html">
            
                <a href="../ring/middleware_registry.html">
            
                    
                    Middleware Registry
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.10" data-path="../ring/default_middleware.html">
            
                <a href="../ring/default_middleware.html">
            
                    
                    Default Middleware
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.11" data-path="../ring/coercion.html">
            
                <a href="../ring/coercion.html">
            
                    
                    Pluggable Coercion
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.12" data-path="../ring/route_data_validation.html">
            
                <a href="../ring/route_data_validation.html">
            
                    
                    Route Data Validation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.13" data-path="../ring/compiling_middleware.html">
            
                <a href="../ring/compiling_middleware.html">
            
                    
                    Compiling Middleware
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.14" data-path="../ring/swagger.html">
            
                <a href="../ring/swagger.html">
            
                    
                    Swagger Support
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">HTTP</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../http/interceptors.html">
            
                <a href="../http/interceptors.html">
            
                    
                    Interceptors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="../http/pedestal.html">
            
                <a href="../http/pedestal.html">
            
                    
                    Pedestal
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="../http/sieppari.html">
            
                <a href="../http/sieppari.html">
            
                    
                    Sieppari
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="../http/default_interceptors.html">
            
                <a href="../http/default_interceptors.html">
            
                    
                    Default Interceptors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="../http/transforming_interceptor_chain.html">
            
                <a href="../http/transforming_interceptor_chain.html">
            
                    
                    Transforming Interceptor Chain
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Frontend</li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="../frontend/basics.html">
            
                <a href="../frontend/basics.html">
            
                    
                    Basics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="../frontend/browser.html">
            
                <a href="../frontend/browser.html">
            
                    
                    Browser integration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="../frontend/controllers.html">
            
                <a href="../frontend/controllers.html">
            
                    
                    Controllers
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Advanced</li>
        
        
    
        <li class="chapter " data-level="7.1" data-path="configuring_routers.html">
            
                <a href="configuring_routers.html">
            
                    
                    Configuring Routers
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="7.2" data-path="composing_routers.html">
            
                <a href="composing_routers.html">
            
                    
                    Composing Routers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.3" data-path="different_routers.html">
            
                <a href="different_routers.html">
            
                    
                    Different Routers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.4" data-path="route_validation.html">
            
                <a href="route_validation.html">
            
                    
                    Route Validation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.5" data-path="dev_workflow.html">
            
                <a href="dev_workflow.html">
            
                    
                    Dev Workflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.6" data-path="shared_routes.html">
            
                <a href="shared_routes.html">
            
                    
                    Shared Routes
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Misc</li>
        
        
    
        <li class="chapter " data-level="8.1" data-path="../performance.html">
            
                <a href="../performance.html">
            
                    
                    Performance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.2" data-path="../development.html">
            
                <a href="../development.html">
            
                    
                    Development Instructions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.3" data-path="../faq.html">
            
                <a href="../faq.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Composing Routers</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="composing-routers">Composing Routers</h1>
<p>Data-driven approach in <code>reitit</code> allows us to compose routes, route data, route specs, middleware and interceptors chains. We can compose routers too. This is needed to achieve dynamic routing like in <a href="https://github.com/weavejester/compojure" target="_blank">Compojure</a>.</p>
<h2 id="immutatability">Immutatability</h2>
<p>Once a router is created, the routing tree is immutable and cannot be changed. To change the routing, we need to create a new router with changed routes and/or options. For this, the <code>Router</code> protocol exposes it&apos;s resolved routes via <code>r/routes</code> and options via <code>r/options</code>.</p>
<h2 id="adding-routes">Adding routes</h2>
<p>Let&apos;s create a router:</p>
<pre><code class="lang-clj">(<span class="hljs-name">require</span> &apos;[reitit.core <span class="hljs-symbol">:as</span> r])

(<span class="hljs-name"><span class="hljs-builtin-name">def</span></span> router
  (<span class="hljs-name">r/router</span>
    [[<span class="hljs-string">&quot;/foo&quot;</span> <span class="hljs-symbol">::foo</span>]
     [<span class="hljs-string">&quot;/bar/:id&quot;</span> <span class="hljs-symbol">::bar</span>]]))
</code></pre>
<p>We can query the resolved routes and options:</p>
<pre><code class="lang-clj">(<span class="hljs-name">r/routes</span> router)
<span class="hljs-comment">;[[&quot;/foo&quot; {:name :user/foo}]</span>
<span class="hljs-comment">; [&quot;/bar/:id&quot; {:name :user/bar}]]</span>

(<span class="hljs-name">r/options</span> router)
<span class="hljs-comment">;{:lookup #object[...]</span>
<span class="hljs-comment">; :expand #object[...]</span>
<span class="hljs-comment">; :coerce #object[...]</span>
<span class="hljs-comment">; :compile #object[...]</span>
<span class="hljs-comment">; :conflicts #object[...]}</span>
</code></pre>
<p>Let&apos;s add a helper function to create a new router with extra routes:</p>
<pre><code class="lang-clj">(<span class="hljs-name"><span class="hljs-builtin-name">defn</span></span> add-routes [router routes]
  (<span class="hljs-name">r/router</span>
    (<span class="hljs-name"><span class="hljs-builtin-name">into</span></span> (<span class="hljs-name">r/routes</span> router) routes)
    (<span class="hljs-name">r/options</span> router)))
</code></pre>
<p>We can now create a new router with an extra routes:</p>
<pre><code class="lang-clj">(<span class="hljs-name"><span class="hljs-builtin-name">def</span></span> router2
  (<span class="hljs-name">add-routes</span>
    router
    [[<span class="hljs-string">&quot;/baz/:id/:subid&quot;</span> <span class="hljs-symbol">::baz</span>]]))

(<span class="hljs-name">r/routes</span> router2)
<span class="hljs-comment">;[[&quot;/foo&quot; {:name :user/foo}]</span>
<span class="hljs-comment">; [&quot;/bar/:id&quot; {:name :user/bar}]</span>
<span class="hljs-comment">; [&quot;/baz/:id/:subid&quot; {:name :user/baz}]]</span>
</code></pre>
<p>The original router was not changed:</p>
<pre><code class="lang-clj">(<span class="hljs-name">r/routes</span> router)
<span class="hljs-comment">;[[&quot;/foo&quot; {:name :user/foo}]</span>
<span class="hljs-comment">; [&quot;/bar/:id&quot; {:name :user/bar}]]</span>
</code></pre>
<p>When a new router is created, all rules are applied, including the conflict resolution:</p>
<pre><code class="lang-clj">(<span class="hljs-name">add-routes</span>
  router2
  [[<span class="hljs-string">&quot;/:this/should/:fail&quot;</span> <span class="hljs-symbol">::fail</span>]])
<span class="hljs-comment">;CompilerException clojure.lang.ExceptionInfo: Router contains conflicting route paths:</span>
<span class="hljs-comment">;</span>
<span class="hljs-comment">;   /baz/:id/:subid</span>
<span class="hljs-comment">;-&gt; /:this/should/:fail</span>
</code></pre>
<h2 id="merging-routers">Merging routers</h2>
<p>Let&apos;s create a helper function to merge routers:</p>
<pre><code class="lang-clj">(<span class="hljs-name"><span class="hljs-builtin-name">defn</span></span> merge-routers [&amp; routers]
  (<span class="hljs-name">r/router</span>
    (<span class="hljs-name"><span class="hljs-builtin-name">apply</span></span> merge (<span class="hljs-name"><span class="hljs-builtin-name">map</span></span> r/routes routers))
    (<span class="hljs-name"><span class="hljs-builtin-name">apply</span></span> merge (<span class="hljs-name"><span class="hljs-builtin-name">map</span></span> r/options routers))))
</code></pre>
<p>We can now merge multiple routers into one:</p>
<pre><code class="lang-clj">(<span class="hljs-name"><span class="hljs-builtin-name">def</span></span> router
  (<span class="hljs-name">merge-routers</span>
    (<span class="hljs-name">r/router</span> [<span class="hljs-string">&quot;/route1&quot;</span> <span class="hljs-symbol">::route1</span>])
    (<span class="hljs-name">r/router</span> [<span class="hljs-string">&quot;/route2&quot;</span> <span class="hljs-symbol">::route2</span>])
    (<span class="hljs-name">r/router</span> [<span class="hljs-string">&quot;/route3&quot;</span> <span class="hljs-symbol">::route3</span>])))

(<span class="hljs-name">r/routes</span> router)
<span class="hljs-comment">;[[&quot;/route1&quot; {:name :user/route1}]</span>
<span class="hljs-comment">; [&quot;/route2&quot; {:name :user/route2}]</span>
<span class="hljs-comment">; [&quot;/route3&quot; {:name :user/route3}]]</span>
</code></pre>
<h2 id="nesting-routers">Nesting routers</h2>
<p>Routers can be nested using the catch-all parameter.</p>
<p>Here&apos;s a router with deeply nested routers under a <code>:router</code> key in the route data:</p>
<pre><code class="lang-clj">(<span class="hljs-name"><span class="hljs-builtin-name">def</span></span> router
  (<span class="hljs-name">r/router</span>
    [[<span class="hljs-string">&quot;/ping&quot;</span> <span class="hljs-symbol">:ping</span>]
     [<span class="hljs-string">&quot;/olipa/*&quot;</span> {<span class="hljs-symbol">:name</span> <span class="hljs-symbol">:olipa</span>
                  <span class="hljs-symbol">:router</span> (<span class="hljs-name">r/router</span>
                            [[<span class="hljs-string">&quot;/olut&quot;</span> <span class="hljs-symbol">:olut</span>]
                             [<span class="hljs-string">&quot;/makkara&quot;</span> <span class="hljs-symbol">:makkara</span>]
                             [<span class="hljs-string">&quot;/kerran/*&quot;</span> {<span class="hljs-symbol">:name</span> <span class="hljs-symbol">:kerran</span>
                                           <span class="hljs-symbol">:router</span> (<span class="hljs-name">r/router</span>
                                                     [[<span class="hljs-string">&quot;/avaruus&quot;</span> <span class="hljs-symbol">:avaruus</span>]
                                                      [<span class="hljs-string">&quot;/ihminen&quot;</span> <span class="hljs-symbol">:ihminen</span>]])}]])}]]))
</code></pre>
<p>Matching by path:</p>
<pre><code class="lang-clj">(<span class="hljs-name">r/match-by-path</span> router <span class="hljs-string">&quot;/olipa/kerran/iso/kala&quot;</span>)
<span class="hljs-comment">;#Match{:template &quot;/olipa/*&quot;</span>
<span class="hljs-comment">;       :data {:name :olipa</span>
<span class="hljs-comment">;              :router #object[reitit.core$mixed_router]}</span>
<span class="hljs-comment">;       :result nil</span>
<span class="hljs-comment">;       :path-params {: &quot;kerran/iso/kala&quot;}</span>
<span class="hljs-comment">;       :path &quot;/olipa/iso/kala&quot;}</span>
</code></pre>
<p>That didn&apos;t work as we wanted, as the nested routers don&apos;t have such a route. The core routing doesn&apos;t understand anything the <code>:router</code> key, so it only matched against the top-level router, which gave a match for the catch-all path.</p>
<p>As the <code>Match</code> contains all the route data, we can create a new matching function that understands the <code>:router</code> key. Below is a function that does recursive matching using the subrouters. It returns either <code>nil</code> or a vector of mathces.</p>
<pre><code class="lang-clj">(<span class="hljs-name">require</span> &apos;[clojure.string <span class="hljs-symbol">:as</span> str])

(<span class="hljs-name"><span class="hljs-builtin-name">defn</span></span> recursive-match-by-path [router path]
  (<span class="hljs-name"><span class="hljs-builtin-name">if-let</span></span> [match (<span class="hljs-name">r/match-by-path</span> router path)]
    (<span class="hljs-name"><span class="hljs-builtin-name">if-let</span></span> [subrouter (<span class="hljs-name"><span class="hljs-builtin-name">-&gt;</span></span> match <span class="hljs-symbol">:data</span> <span class="hljs-symbol">:router</span>)]
      (<span class="hljs-name"><span class="hljs-builtin-name">let</span></span> [subpath (<span class="hljs-name">subs</span> path (<span class="hljs-name">str/last-index-of</span> (<span class="hljs-symbol">:template</span> match) <span class="hljs-string">&quot;/&quot;</span>))]
        (<span class="hljs-name"><span class="hljs-builtin-name">if-let</span></span> [submatch (<span class="hljs-name">recursive-match-by-path</span> subrouter subpath)]
          (<span class="hljs-name"><span class="hljs-builtin-name">cons</span></span> match submatch)))
      (<span class="hljs-name"><span class="hljs-builtin-name">list</span></span> match))))
</code></pre>
<p>With invalid nested path we get now <code>nil</code> as expected:</p>
<pre><code class="lang-clj">(<span class="hljs-name">recursive-match-by-path</span> router <span class="hljs-string">&quot;/olipa/kerran/iso/kala&quot;</span>)
<span class="hljs-comment">; nil</span>
</code></pre>
<p>With valid path we get all the nested matches:</p>
<pre><code class="lang-clj">(<span class="hljs-name">recursive-match-by-path</span> router <span class="hljs-string">&quot;/olipa/kerran/avaruus&quot;</span>)
<span class="hljs-comment">;[#reitit.core.Match{:template &quot;/olipa/*&quot;</span>
<span class="hljs-comment">;                    :data {:name :olipa</span>
<span class="hljs-comment">;                           :router #object[reitit.core$mixed_router]}</span>
<span class="hljs-comment">;                    :result nil</span>
<span class="hljs-comment">;                    :path-params {: &quot;kerran/avaruus&quot;}</span>
<span class="hljs-comment">;                    :path &quot;/olipa/kerran/avaruus&quot;}</span>
<span class="hljs-comment">; #reitit.core.Match{:template &quot;/kerran/*&quot;</span>
<span class="hljs-comment">;                    :data {:name :kerran</span>
<span class="hljs-comment">;                           :router #object[reitit.core$lookup_router]}</span>
<span class="hljs-comment">;                    :result nil</span>
<span class="hljs-comment">;                    :path-params {: &quot;avaruus&quot;}</span>
<span class="hljs-comment">;                    :path &quot;/kerran/avaruus&quot;}</span>
<span class="hljs-comment">; #reitit.core.Match{:template &quot;/avaruus&quot; </span>
<span class="hljs-comment">;                    :data {:name :avaruus} </span>
<span class="hljs-comment">;                    :result nil </span>
<span class="hljs-comment">;                    :path-params {} </span>
<span class="hljs-comment">;                    :path &quot;/avaruus&quot;}]</span>
</code></pre>
<p>Let&apos;s create a helper to get only the route names for matches:</p>
<pre><code class="lang-clj">(<span class="hljs-name"><span class="hljs-builtin-name">defn</span></span> name-path [router path]
  (<span class="hljs-name">some-&gt;&gt;</span> (<span class="hljs-name">recursive-match-by-path</span> router path)
           (<span class="hljs-name"><span class="hljs-builtin-name">mapv</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">comp</span></span> <span class="hljs-symbol">:name</span> <span class="hljs-symbol">:data</span>))))

(<span class="hljs-name">name-path</span> router <span class="hljs-string">&quot;/olipa/kerran/avaruus&quot;</span>)
<span class="hljs-comment">; [:olipa :kerran :avaruus]</span>
</code></pre>
<p>So, we can nest routers, but why would we do that?</p>
<h2 id="dynamic-routing">Dynamic routing</h2>
<p>In all the examples above, the routers were created ahead of time, making the whole route tree effective static.  To have more dynamic routing, we can use router references allowing the router to be swapped over time. We can also create fully dynamic routers where the router is re-created for each request. Let&apos;s walk through both cases.</p>
<p>First, we need to modify our matching function to support router references:</p>
<pre><code class="lang-clj">(<span class="hljs-name"><span class="hljs-builtin-name">defn-</span></span> &lt;&lt; [x] 
  (<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">instance?</span></span> clojure.lang.IDeref x) 
    (<span class="hljs-name"><span class="hljs-builtin-name">deref</span></span> x) x))

(<span class="hljs-name"><span class="hljs-builtin-name">defn</span></span> recursive-match-by-path [router path]
  (<span class="hljs-name"><span class="hljs-builtin-name">if-let</span></span> [match (<span class="hljs-name">r/match-by-path</span> (<span class="hljs-name">&lt;&lt;</span> router) path)]
    (<span class="hljs-name"><span class="hljs-builtin-name">if-let</span></span> [subrouter (<span class="hljs-name"><span class="hljs-builtin-name">-&gt;</span></span> match <span class="hljs-symbol">:data</span> <span class="hljs-symbol">:router</span> &lt;&lt;)]
      (<span class="hljs-name"><span class="hljs-builtin-name">let</span></span> [subpath (<span class="hljs-name">subs</span> path (<span class="hljs-name">str/last-index-of</span> (<span class="hljs-symbol">:template</span> match) <span class="hljs-string">&quot;/&quot;</span>))]
        (<span class="hljs-name"><span class="hljs-builtin-name">if-let</span></span> [submatch (<span class="hljs-name">recursive-match-by-path</span> subrouter subpath)]
          (<span class="hljs-name"><span class="hljs-builtin-name">cons</span></span> match submatch)))
      (<span class="hljs-name"><span class="hljs-builtin-name">list</span></span> match))))
</code></pre>
<p>Then, we need some routers.</p>
<p>First, a reference to a router that can be updated on background, for example when a new entry in inserted into a database. We&apos;ll wrap the router into a <code>atom</code>:</p>
<pre><code class="lang-clj">(<span class="hljs-name"><span class="hljs-builtin-name">def</span></span> beer-router
  (<span class="hljs-name"><span class="hljs-builtin-name">atom</span></span>
    (<span class="hljs-name">r/router</span> 
      [[<span class="hljs-string">&quot;/lager&quot;</span> <span class="hljs-symbol">:lager</span>]])))
</code></pre>
<p>Second, a reference to router, which is re-created on each routing request:</p>
<pre><code class="lang-clj">(<span class="hljs-name"><span class="hljs-builtin-name">def</span></span> dynamic-router
  (<span class="hljs-name"><span class="hljs-builtin-name">reify</span></span> clojure.lang.IDeref
    (<span class="hljs-name"><span class="hljs-builtin-name">deref</span></span> [_]
      (<span class="hljs-name">r/router</span>
        [<span class="hljs-string">&quot;/duo&quot;</span> (<span class="hljs-name"><span class="hljs-builtin-name">keyword</span></span> (<span class="hljs-name"><span class="hljs-builtin-name">str</span></span> <span class="hljs-string">&quot;duo&quot;</span> (<span class="hljs-name"><span class="hljs-builtin-name">rand-int</span></span> <span class="hljs-number">100</span>)))]))))
</code></pre>
<p>We can compose the routers into a system-level static root router:</p>
<pre><code class="lang-clj">(<span class="hljs-name"><span class="hljs-builtin-name">def</span></span> router
  (<span class="hljs-name">r/router</span>
    [[<span class="hljs-string">&quot;/gin/napue&quot;</span> <span class="hljs-symbol">:napue</span>]
     [<span class="hljs-string">&quot;/ciders/*&quot;</span> <span class="hljs-symbol">:ciders</span>]
     [<span class="hljs-string">&quot;/beers/*&quot;</span> {<span class="hljs-symbol">:name</span> <span class="hljs-symbol">:beers</span>
                  <span class="hljs-symbol">:router</span> beer-router}]
     [<span class="hljs-string">&quot;/dynamic/*&quot;</span> {<span class="hljs-symbol">:name</span> <span class="hljs-symbol">:dynamic</span>
                    <span class="hljs-symbol">:router</span> dynamic-router}]]))
</code></pre>
<p>Matching root routes:</p>
<pre><code class="lang-clj">(<span class="hljs-name">name-path</span> router <span class="hljs-string">&quot;/vodka/russian&quot;</span>)
<span class="hljs-comment">; nil</span>

(<span class="hljs-name">name-path</span> router <span class="hljs-string">&quot;/gin/napue&quot;</span>)
<span class="hljs-comment">; [:napue]</span>
</code></pre>
<p>Matching (nested) beer routes:</p>
<pre><code class="lang-clj">(<span class="hljs-name">name-path</span> router <span class="hljs-string">&quot;/beers/lager&quot;</span>)
<span class="hljs-comment">; [:beers :lager]</span>

(<span class="hljs-name">name-path</span> router <span class="hljs-string">&quot;/beers/saison&quot;</span>)
<span class="hljs-comment">; nil</span>
</code></pre>
<p>No saison!? Let&apos;s add the route:</p>
<pre><code class="lang-clj">(<span class="hljs-name"><span class="hljs-builtin-name">swap!</span></span> beer-router add-routes [[<span class="hljs-string">&quot;/saison&quot;</span> <span class="hljs-symbol">:saison</span>]])
</code></pre>
<p>There we have it:</p>
<pre><code class="lang-clj">(<span class="hljs-name">name-path</span> router <span class="hljs-string">&quot;/beers/saison&quot;</span>)
<span class="hljs-comment">; [:beers :saison]</span>
</code></pre>
<p>We can&apos;t add conflicting routes:</p>
<pre><code class="lang-clj">(<span class="hljs-name"><span class="hljs-builtin-name">swap!</span></span> beer-router add-routes [[<span class="hljs-string">&quot;/saison&quot;</span> <span class="hljs-symbol">:saison</span>]])
<span class="hljs-comment">;CompilerException clojure.lang.ExceptionInfo: Router contains conflicting route paths:</span>
<span class="hljs-comment">;</span>
<span class="hljs-comment">;   /saison</span>
<span class="hljs-comment">;-&gt; /saison</span>
</code></pre>
<p>The dynamic routes are re-created on every request:</p>
<pre><code class="lang-clj">(<span class="hljs-name">name-path</span> router <span class="hljs-string">&quot;/dynamic/duo&quot;</span>)
<span class="hljs-comment">; [:dynamic :duo71]</span>

(<span class="hljs-name">name-path</span> router <span class="hljs-string">&quot;/dynamic/duo&quot;</span>)
<span class="hljs-comment">; [:dynamic :duo55]</span>
</code></pre>
<h3 id="performance">Performance</h3>
<p>With nested routers, instead of having to do just one route match, matching is recursive, which adds a small cost. All nested routers need to be of type catch-all at top-level, which is order of magnitude slower than fully static routes. Dynamic routes are the slowest ones, at least two orders of magnitude slower, as the router needs to be recreated for each request.</p>
<p>A quick benchmark on the recursive lookups:</p>
<table>
<thead>
<tr>
<th>path</th>
<th>time</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/gin/napue</code></td>
<td>40ns</td>
<td>static</td>
</tr>
<tr>
<td><code>/ciders/weston</code></td>
<td>440ns</td>
<td>catch-all</td>
</tr>
<tr>
<td><code>/beers/saison</code></td>
<td>600ns</td>
<td>catch-all + static</td>
</tr>
<tr>
<td><code>/dynamic/duo</code></td>
<td>12000ns</td>
<td>catch-all + dynamic</td>
</tr>
</tbody>
</table>
<p>The non-recursive lookup for <code>/gin/napue</code> is around 23ns.</p>
<p>Comparing the dynamic routing performance with Compojure:</p>
<pre><code class="lang-clj">(<span class="hljs-name">require</span> &apos;[compojure.core <span class="hljs-symbol">:refer</span> [context])

(<span class="hljs-name"><span class="hljs-builtin-name">def</span></span> app
  (<span class="hljs-name">context</span> <span class="hljs-string">&quot;/dynamic&quot;</span> [] (<span class="hljs-name"><span class="hljs-builtin-name">constantly</span></span> <span class="hljs-symbol">:duo</span>)))

(<span class="hljs-name">app</span> {<span class="hljs-symbol">:uri</span> <span class="hljs-string">&quot;/dynamic/duo&quot;</span> <span class="hljs-symbol">:request-method</span> <span class="hljs-symbol">:get</span>})
<span class="hljs-comment">; :duo</span>
</code></pre>
<table>
<thead>
<tr>
<th>path</th>
<th>time</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/dynamic/duo</code></td>
<td>20000ns</td>
<td>compojure</td>
</tr>
</tbody>
</table>
<p>Can we make the nester routing faster? Sure. We could use the Router <code>:compile</code> hook to compile the nested routers for better performance. We could also allow router creation rules to be disabled, to get the dynamic routing much faster.</p>
<h3 id="when-to-use-nested-routers">When to use nested routers?</h3>
<p>Nesting routers is not trivial and because of that, should be avoided. For dynamic (request-time) route generation, it&apos;s the only choise. For other cases, nested routes are most likely a better option.</p>
<p>Let&apos;s re-create the previous example with normal route nesting/composition.</p>
<p>A helper to the root router:</p>
<pre><code class="lang-clj">(<span class="hljs-name"><span class="hljs-builtin-name">defn</span></span> create-router [beers]
  (<span class="hljs-name">r/router</span>
    [[<span class="hljs-string">&quot;/gin/napue&quot;</span> <span class="hljs-symbol">:napue</span>]
     [<span class="hljs-string">&quot;/ciders/*&quot;</span> <span class="hljs-symbol">:ciders</span>]
     [<span class="hljs-string">&quot;/beers&quot;</span> (<span class="hljs-name"><span class="hljs-builtin-name">for</span></span> [beer beers]
                 [(<span class="hljs-name"><span class="hljs-builtin-name">str</span></span> <span class="hljs-string">&quot;/&quot;</span> beer) (<span class="hljs-name"><span class="hljs-builtin-name">keyword</span></span> <span class="hljs-string">&quot;beer&quot;</span> beer)])]
     [<span class="hljs-string">&quot;/dynamic/*&quot;</span> {<span class="hljs-symbol">:name</span> <span class="hljs-symbol">:dynamic</span>
                    <span class="hljs-symbol">:router</span> dynamic-router}]]))
</code></pre>
<p>New new root router <em>reference</em> and a helper to reset it:</p>
<pre><code class="lang-clj">(<span class="hljs-name"><span class="hljs-builtin-name">def</span></span> router
  (<span class="hljs-name"><span class="hljs-builtin-name">atom</span></span> (<span class="hljs-name">create-router</span> <span class="hljs-literal">nil</span>)))

(<span class="hljs-name"><span class="hljs-builtin-name">defn</span></span> reset-router! [beers]
  (<span class="hljs-name"><span class="hljs-builtin-name">reset!</span></span> router (<span class="hljs-name">create-router</span> beers)))
</code></pre>
<p>The routing tree:</p>
<pre><code class="lang-clj">(<span class="hljs-name">r/routes</span> @router)
<span class="hljs-comment">;[[&quot;/gin/napue&quot; {:name :napue}]</span>
<span class="hljs-comment">; [&quot;/ciders/*&quot; {:name :ciders}]</span>
<span class="hljs-comment">; [&quot;/dynamic/*&quot; {:name :dynamic,</span>
<span class="hljs-comment">;                :router #object[user$reify__24359]}]]</span>
</code></pre>
<p>Let&apos;s reset the router with some beers:</p>
<pre><code class="lang-clj">(<span class="hljs-name">reset-router!</span> [<span class="hljs-string">&quot;lager&quot;</span> <span class="hljs-string">&quot;sahti&quot;</span> <span class="hljs-string">&quot;bock&quot;</span>])
</code></pre>
<p>We can see that the beer routes are now embedded into the core router:</p>
<pre><code class="lang-clj">(<span class="hljs-name">r/routes</span> @router)
<span class="hljs-comment">;[[&quot;/gin/napue&quot; {:name :napue}]</span>
<span class="hljs-comment">; [&quot;/ciders/*&quot; {:name :ciders}]</span>
<span class="hljs-comment">; [&quot;/beers/lager&quot; {:name :beer/lager}]</span>
<span class="hljs-comment">; [&quot;/beers/sahti&quot; {:name :beer/sahti}]</span>
<span class="hljs-comment">; [&quot;/beers/bock&quot; {:name :beer/bock}]</span>
<span class="hljs-comment">; [&quot;/dynamic/*&quot; {:name :dynamic,</span>
<span class="hljs-comment">;                :router #object[user$reify__24359]}]]</span>
</code></pre>
<p>And the routing works:</p>
<pre><code class="lang-clj">(<span class="hljs-name">name-path</span> @router <span class="hljs-string">&quot;/beers/sahti&quot;</span>)
<span class="hljs-comment">;[:beer/sahti]</span>
</code></pre>
<p>All the beer-routes now match in constant time.</p>
<table>
<thead>
<tr>
<th>path</th>
<th>time</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/beers/sahti</code></td>
<td>40ns</td>
<td>static</td>
</tr>
</tbody>
</table>
<h2 id="todo">TODO</h2>
<ul>
<li>add an example how to do dynamic routing with <code>reitit-ring</code></li>
<li>maybe create a <code>recursive-router</code> into a separate ns with all <code>Router</code> functions implemented correctly? maybe not...</li>
<li>add <code>reitit.core/merge-routes</code> to effectively merge routes with route data</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="configuring_routers.html" class="navigation navigation-prev " aria-label="Previous page: Configuring Routers">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="different_routers.html" class="navigation navigation-next " aria-label="Next page: Different Routers">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Composing Routers","level":"7.2","depth":1,"next":{"title":"Different Routers","level":"7.3","depth":1,"path":"advanced/different_routers.md","ref":"advanced/different_routers.md","articles":[]},"previous":{"title":"Configuring Routers","level":"7.1","depth":1,"path":"advanced/configuring_routers.md","ref":"advanced/configuring_routers.md","articles":[]},"dir":"ltr"},"config":{"plugins":["hints","editlink","github","highlight"],"root":"doc","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"github":{"url":"https://github.com/metosin/reitit"},"editlink":{"label":"Edit This Page","multilingual":false,"base":"https://github.com/metosin/reitit/tree/master/doc"},"search":{},"hints":{"danger":"fa fa-exclamation-circle","info":"fa fa-info-circle","tip":"fa fa-mortar-board","working":"fa fa-wrench"},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"gitbook":"*"},"file":{"path":"advanced/composing_routers.md","mtime":"2019-01-26T14:20:54.509Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-01-26T14:21:15.546Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-editlink/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

